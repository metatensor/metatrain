<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../genindex.html"><link rel="search" title="Search" href="../search.html"><link rel="next" title="Dataset Information" href="dataset-information.html"><link rel="prev" title="Life Cycle of an Architecture" href="architecture-life-cycle.html">
        <link rel="canonical" href="https://docs.metatensor.org/metatrain/latest/dev-docs/new-architecture.html">
        <link rel="prefetch" href="../_static/images/metatrain-horizontal.png" as="image">
        <link rel="prefetch" href="../_static/images/metatrain-horizontal-dark.png" as="image">

    <link rel="shortcut icon" href="../_static/metatrain-64.png"><!-- Generated with Sphinx 8.2.3 and Furo 2025.12.19 -->
        <title>Adding a new architecture - metatrain 2026.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=7bdb33bb" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=8dab3a3b" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/fontawesome.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/solid.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/brands.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles.css?v=e1ddca15" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">metatrain 2026.1 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../_static/images/metatrain-horizontal.png" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../_static/images/metatrain-horizontal-dark.png" alt="Dark Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation/installation.html">Installation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../getting-started/index.html">Getting started</a><input aria-label="Toggle navigation of Getting started" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/quickstart.html">Quickstart</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/train_yaml_config.html">Training YAML Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/override.html">Override Architecture’s Default Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/checkpoints.html">Restarting and Checkpoints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/units.html">Units</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../architectures/index.html">Available Architectures</a><input aria-label="Toggle navigation of Available Architectures" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../architectures/generated/flashmd.html">FlashMD</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architectures/generated/gap.html">GAP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architectures/generated/llpr.html">LLPR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architectures/generated/mace.html">MACE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architectures/generated/nanopet.html">NanoPET (deprecated)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architectures/generated/pet.html">PET</a></li>
<li class="toctree-l2"><a class="reference internal" href="../architectures/generated/soap_bpnn.html">SOAP-BPNN</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../generated_examples/index.html">Tutorials</a><input aria-label="Toggle navigation of Tutorials" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../generated_examples/0-beginner/index.html">Beginner Tutorials</a><input aria-label="Toggle navigation of Beginner Tutorials" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../generated_examples/0-beginner/00-basic-usage.html">Basic Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated_examples/0-beginner/01-data_preparation.html">How to prepare data for training</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated_examples/0-beginner/02-fine-tuning.html">Fine-tuning a pre-trained model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated_examples/0-beginner/03-train_from_scratch.html">Training a model from scratch</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated_examples/0-beginner/04-parity_plot.html">Model validation with parity plots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated_examples/0-beginner/05-run_ase.html">Running molecular dynamics with ASE</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../generated_examples/1-advanced/index.html">Advanced Tutorials</a><input aria-label="Toggle navigation of Advanced Tutorials" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../generated_examples/1-advanced/00-transfer-learning.html">Transfer Learning (experimental)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated_examples/1-advanced/01-llpr.html">Computing LLPR uncertainties</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated_examples/1-advanced/02-zbl.html">Training a model with ZBL corrections</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated_examples/1-advanced/03-fitting-generic-targets.html">Fitting generic targets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated_examples/1-advanced/04-flashmd.html">Training or fine-tuning a FlashMD model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated_examples/1-advanced/05-multi-gpu.html">Multi-GPU training</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated_examples/1-advanced/06-mixed-stress-training.html">Training with Mixed Stress Structures</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated_examples/1-advanced/07-dos-training.html">Training a DOS model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../generated_examples/1-advanced/08-llpr-ensemble-training.html">Generating and training an LLPR-derived shallow ensemble model</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../concepts/index.html">Concepts and Design</a><input aria-label="Toggle navigation of Concepts and Design" class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../concepts/output-naming.html">Output naming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/fine-tuning.html">Fine-tune a pre-trained model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/loss-functions.html">Loss functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/auxiliary-outputs.html">Auxiliary outputs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/batch-bounds.html">Training with Batch Bounds</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cite.html">Citing Metatrain</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Developer documentation</a><input aria-label="Toggle navigation of Developer documentation" checked="" class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="getting-started.html">Contributing</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture-life-cycle.html">Life Cycle of an Architecture</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Adding a new architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="dataset-information.html">Dataset Information</a></li>
<li class="toctree-l2"><a class="reference internal" href="new-loss.html">Adding a new loss function</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="cli/index.html">CLI API</a><input aria-label="Toggle navigation of CLI API" class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l3"><a class="reference internal" href="cli/train.html">Train</a></li>
<li class="toctree-l3"><a class="reference internal" href="cli/eval.html">Eval</a></li>
<li class="toctree-l3"><a class="reference internal" href="cli/export.html">Export</a></li>
<li class="toctree-l3"><a class="reference internal" href="cli/formatter.html">Formatter</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="utils/index.html">Utility API</a><input aria-label="Toggle navigation of Utility API" class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="utils/additive/index.html">Additive models</a><input aria-label="Toggle navigation of Additive models" class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="utils/additive/remove_additive.html">Removing additive contributions</a></li>
<li class="toctree-l4"><a class="reference internal" href="utils/additive/composition.html">Composition model</a></li>
<li class="toctree-l4"><a class="reference internal" href="utils/additive/zbl.html">ZBL short-range potential</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="utils/scaler/index.html">Scaler models</a><input aria-label="Toggle navigation of Scaler models" class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="utils/scaler/scaler.html">Scaler model</a></li>
<li class="toctree-l4"><a class="reference internal" href="utils/scaler/remove_scale.html">Removing the scale from targets</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="utils/data/index.html">Data</a><input aria-label="Toggle navigation of Data" class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="utils/data/combine_dataloaders.html">Combining dataloaders</a></li>
<li class="toctree-l4"><a class="reference internal" href="utils/data/dataset.html">Dataset</a></li>
<li class="toctree-l4"><a class="reference internal" href="utils/data/get_dataset.html">Reading a dataset</a></li>
<li class="toctree-l4"><a class="reference internal" href="utils/data/readers.html">Readers</a></li>
<li class="toctree-l4"><a class="reference internal" href="utils/data/writers.html">Target data Writers</a></li>
<li class="toctree-l4"><a class="reference internal" href="utils/data/systems_to_ase.html">Converting Systems to ASE</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="utils/abc.html">Abstract base classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="utils/architectures.html">Architectures</a></li>
<li class="toctree-l3"><a class="reference internal" href="utils/augmentation.html">Augmentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="utils/devices.html">Device</a></li>
<li class="toctree-l3"><a class="reference internal" href="utils/dtype.html">Dtype</a></li>
<li class="toctree-l3"><a class="reference internal" href="utils/errors.html">Errors</a></li>
<li class="toctree-l3"><a class="reference internal" href="utils/evaluate_model.html">Evaluating a model</a></li>
<li class="toctree-l3"><a class="reference internal" href="utils/external_naming.html">External Naming</a></li>
<li class="toctree-l3"><a class="reference internal" href="utils/hypers.html">Hyperparameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="utils/io.html">IO</a></li>
<li class="toctree-l3"><a class="reference internal" href="utils/logging.html">Logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="utils/long_range.html">Long-range</a></li>
<li class="toctree-l3"><a class="reference internal" href="utils/loss.html">Loss</a></li>
<li class="toctree-l3"><a class="reference internal" href="utils/metrics.html">Metrics</a></li>
<li class="toctree-l3"><a class="reference internal" href="utils/neighbor_lists.html">Neighbor lists</a></li>
<li class="toctree-l3"><a class="reference internal" href="utils/omegaconf.html">Custom omegaconf functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="utils/output_gradient.html">Output gradient</a></li>
<li class="toctree-l3"><a class="reference internal" href="utils/per_atom.html">Averaging predictions per atom</a></li>
<li class="toctree-l3"><a class="reference internal" href="utils/pydantic.html">Pydantic utilities</a></li>
<li class="toctree-l3"><a class="reference internal" href="utils/sum_over_atoms.html">Summing over atoms</a></li>
<li class="toctree-l3"><a class="reference internal" href="utils/testing.html">Testing Utilities</a></li>
<li class="toctree-l3"><a class="reference internal" href="utils/transfer.html">Data type and device transfers</a></li>
<li class="toctree-l3"><a class="reference internal" href="utils/units.html">Unit handling</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="base-hypers.html">Base hyperparameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../_sources/dev-docs/new-architecture.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="adding-a-new-architecture">
<span id="adding-new-architecture"></span><h1>Adding a new architecture<a class="headerlink" href="#adding-a-new-architecture" title="Link to this heading">¶</a></h1>
<p>This page describes the required classes and files necessary for adding a new
architecture to <code class="docutils literal notranslate"><span class="pre">metatrain</span></code> as experimental or stable architecture as
described on the <a class="reference internal" href="architecture-life-cycle.html#architecture-life-cycle"><span class="std std-ref">Life Cycle of an Architecture</span></a> page.</p>
<section id="what-is-a-metatrain-architecture">
<h2>What is a <code class="docutils literal notranslate"><span class="pre">metatrain</span></code> architecture?<a class="headerlink" href="#what-is-a-metatrain-architecture" title="Link to this heading">¶</a></h2>
<p>To work with <code class="docutils literal notranslate"><span class="pre">metatrain</span></code> any architecture has to follow the same public API to
be called correctly within the <a class="reference internal" href="cli/train.html#module-metatrain.cli.train" title="metatrain.cli.train"><code class="xref py py-func docutils literal notranslate"><span class="pre">metatrain.cli.train()</span></code></a> function to
process the user’s options. In brief, the core of the <code class="docutils literal notranslate"><span class="pre">train</span></code> function looks
similar to these lines</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">architecture</span><span class="w"> </span><span class="kn">import</span> <span class="n">__model__</span> <span class="k">as</span> <span class="n">Model</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">architecture</span><span class="w"> </span><span class="kn">import</span> <span class="n">__trainer__</span> <span class="k">as</span> <span class="n">Trainer</span>

<span class="n">hypers</span> <span class="o">=</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="n">dataset_info</span> <span class="o">=</span> <span class="n">DatasetInfo</span><span class="p">()</span>

<span class="k">if</span> <span class="n">checkpoint_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">)</span>

    <span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span>
        <span class="n">checkpoint</span><span class="p">,</span> <span class="n">hypers</span><span class="o">=</span><span class="n">hypers</span><span class="p">[</span><span class="s2">&quot;training&quot;</span><span class="p">],</span> <span class="n">context</span><span class="o">=</span><span class="s2">&quot;restart&quot;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="s2">&quot;restart&quot;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">restart</span><span class="p">(</span><span class="n">dataset_info</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">hypers</span><span class="p">[</span><span class="s2">&quot;training&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hypers</span><span class="p">[</span><span class="s2">&quot;training&quot;</span><span class="p">],</span> <span class="s2">&quot;finetune&quot;</span><span class="p">):</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">hypers</span><span class="p">[</span><span class="s2">&quot;training&quot;</span><span class="p">][</span><span class="s2">&quot;finetune&quot;</span><span class="p">][</span><span class="s2">&quot;read_from&quot;</span><span class="p">]</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="s2">&quot;finetune&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">hypers</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">],</span> <span class="n">dataset_info</span><span class="p">)</span>

<span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
    <span class="n">devices</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">train_datasets</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">val_datasets</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">checkpoint_dir</span><span class="o">=</span><span class="s2">&quot;path&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">(</span><span class="s2">&quot;model.ckpt&quot;</span><span class="p">)</span>

<span class="n">mts_atomistic_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">export</span><span class="p">()</span>
<span class="n">mts_atomistic_model</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="s2">&quot;model.pt&quot;</span><span class="p">,</span> <span class="n">collect_extensions</span><span class="o">=</span><span class="s2">&quot;extensions/&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="general-code-structure">
<h2>General code structure<a class="headerlink" href="#general-code-structure" title="Link to this heading">¶</a></h2>
<p>To follow this, a new architecture has to define two classes</p>
<ul class="simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">Model</span></code> class, defining the core of the architecture. This class must
implement the interface documented in
<a class="reference internal" href="utils/abc.html#metatrain.utils.abc.ModelInterface" title="metatrain.utils.abc.ModelInterface"><code class="xref py py-class docutils literal notranslate"><span class="pre">metatrain.utils.abc.ModelInterface</span></code></a></p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">Trainer</span></code> class, used to train an architecture and produce a model that
can be evaluated and exported. This class must implement the interface
documented below in <a class="reference internal" href="utils/abc.html#metatrain.utils.abc.TrainerInterface" title="metatrain.utils.abc.TrainerInterface"><code class="xref py py-class docutils literal notranslate"><span class="pre">metatrain.utils.abc.TrainerInterface</span></code></a>.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">metatrain</span></code> does not know the types and numbers of targets/datasets an
architecture can handle. As a result, it cannot generate useful error
messages when a user attempts to train an architecture with unsupported
target and dataset combinations. Therefore, it is the responsibility of the
architecture developer to verify if the model and the trainer support the
provided train_datasets and val_datasets passed to the Trainer, as well as
the dataset_info passed to the model.</p>
</div>
<p>The architecture must also define a documentation file which contains the
default hyperparameters, along with their types and descriptions.</p>
<p>To comply with this design each architecture has to implement four files
inside a new architecture directory, either inside the <code class="docutils literal notranslate"><span class="pre">experimental</span></code>
subdirectory or in the <code class="docutils literal notranslate"><span class="pre">root</span></code> of the Python source if the new architecture
already complies with all requirements to be stable. The usual structure of
architecture looks as</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>myarchitecture
    ├── __init__.py
    ├── documentation.py
    ├── model.py
    └── trainer.py
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Because achitectures can live in either <code class="docutils literal notranslate"><span class="pre">src/metatrain/&lt;architecture&gt;</span></code>,
<code class="docutils literal notranslate"><span class="pre">src/metatrain/experimental/&lt;architecture&gt;</span></code>, or
<code class="docutils literal notranslate"><span class="pre">src/metatrain/deprecated/&lt;architecture&gt;</span></code>; the code inside should use
absolute imports use the tools provided by metatrain.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># do not do this</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..utils.dtype</span><span class="w"> </span><span class="kn">import</span> <span class="n">dtype_to_str</span>

<span class="c1"># Do this instead</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">metatrain.utils.dtype</span><span class="w"> </span><span class="kn">import</span> <span class="n">dtype_to_str</span>
</pre></div>
</div>
</div>
</section>
<section id="model-class-model-py">
<h2>Model class (<code class="docutils literal notranslate"><span class="pre">model.py</span></code>)<a class="headerlink" href="#model-class-model-py" title="Link to this heading">¶</a></h2>
<p>A model class has to follow the interface defined in
<a class="reference internal" href="utils/abc.html#metatrain.utils.abc.ModelInterface" title="metatrain.utils.abc.ModelInterface"><code class="xref py py-class docutils literal notranslate"><span class="pre">ModelInterface</span></code></a>. That is, all the
methods that are marked as abstract in the interface must be implemented
with the indicated API (same arguments and same return). At first sight,
the interface might feel overwhelming, therefore here is a summary of the
steps to take to implement a new model class:</p>
<ul class="simple">
<li><p>Implement the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method, which takes as input the model hyperparameters
and the dataset information. This should initialize your model.</p></li>
<li><p>Implement the <code class="docutils literal notranslate"><span class="pre">forward</span></code> method, which defines the forward pass of the model.</p></li>
<li><p>Add some class attributes with <code class="docutils literal notranslate"><span class="pre">__names_like_this__</span></code> that will help metatrain
understand how to treat your model. They are listed and described in the
<a class="reference internal" href="utils/abc.html#metatrain.utils.abc.ModelInterface" title="metatrain.utils.abc.ModelInterface"><code class="xref py py-class docutils literal notranslate"><span class="pre">ModelInterface</span></code></a> documentation.</p></li>
<li><p>Implement the rest of abstract methods, which in general deal with handling
checkpoints, exporting the model, and restarting training from a checkpoint.</p></li>
</ul>
<p>Here is an incomplete example of what a model implementation looks like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">metatomic.torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatasetInfo</span><span class="p">,</span> <span class="n">ModelMetadata</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">metatrain.utils.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelInterface</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyModel</span><span class="p">(</span><span class="n">ModelInterface</span><span class="p">):</span>
    <span class="n">__checkpoint_version__</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">__supported_devices__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cuda&quot;</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">]</span>
    <span class="n">__supported_dtypes__</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span>
    <span class="n">__default_metadata__</span> <span class="o">=</span> <span class="n">ModelMetadata</span><span class="p">(</span>
        <span class="n">references</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;implementation&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;ref1&quot;</span><span class="p">],</span> <span class="s2">&quot;architecture&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;ref2&quot;</span><span class="p">]}</span>
    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hypers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">dataset_info</span><span class="p">:</span> <span class="n">DatasetInfo</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">hypers</span><span class="p">,</span> <span class="n">dataset_info</span><span class="p">)</span>

        <span class="c1"># To access hyperparameters, one can use self.hypers, whose</span>
        <span class="c1"># defaults are defined in the documentation.py file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hypers</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span>
        <span class="o">...</span>

    <span class="c1"># Here one would implement the rest of the abstract methods</span>
</pre></div>
</div>
</section>
<section id="trainer-class-trainer-py">
<h2>Trainer class (<code class="docutils literal notranslate"><span class="pre">trainer.py</span></code>)<a class="headerlink" href="#trainer-class-trainer-py" title="Link to this heading">¶</a></h2>
<p>A trainer class has to follow the interface defined in
<a class="reference internal" href="utils/abc.html#metatrain.utils.abc.TrainerInterface" title="metatrain.utils.abc.TrainerInterface"><code class="xref py py-class docutils literal notranslate"><span class="pre">TrainerInterface</span></code></a>. That is, all the
methods that are marked as abstract in the interface must be implemented
with the indicated API (same arguments and same return). We recommend
looking at existing implementations of trainers for inspiration. They
will look something like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">metatrain.utils.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">TrainerInterface</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyTrainer</span><span class="p">(</span><span class="n">TrainerInterface</span><span class="p">):</span>
    <span class="n">__checkpoint_version__</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hypers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">hypers</span><span class="p">)</span>
        <span class="c1"># To access hyperparameters, one can use self.hypers, whose</span>
        <span class="c1"># defaults are defined in the documentation.py file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hypers</span><span class="p">[</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">]</span>
        <span class="o">...</span>

    <span class="c1"># Here one would implement the rest of the abstract methods</span>
</pre></div>
</div>
</section>
<section id="init-file-init-py">
<h2>Init file (<code class="docutils literal notranslate"><span class="pre">__init__.py</span></code>)<a class="headerlink" href="#init-file-init-py" title="Link to this heading">¶</a></h2>
<p>You are free to name the <code class="docutils literal notranslate"><span class="pre">Model</span></code> and <code class="docutils literal notranslate"><span class="pre">Trainer</span></code> classes as you want. These
classes should then be made available in the <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> under the names
<code class="docutils literal notranslate"><span class="pre">__model__</span></code> and <code class="docutils literal notranslate"><span class="pre">__trainer__</span></code> so metatrain knows where to find them.
<code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> must also contain definition for the original <code class="docutils literal notranslate"><span class="pre">__authors__</span></code>
and current <code class="docutils literal notranslate"><span class="pre">__maintainers__</span></code> of the architecture.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">.model</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelInterface</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.trainer</span><span class="w"> </span><span class="kn">import</span> <span class="n">TrainerInterface</span>

<span class="c1"># class to use as the architecture&#39;s model</span>
<span class="n">__model__</span> <span class="o">=</span> <span class="n">ModelInterface</span>
<span class="c1"># class to use as the architecture&#39;s trainer</span>
<span class="n">__trainer__</span> <span class="o">=</span> <span class="n">TrainerInterface</span>

<span class="c1"># List of the original authors of the architecture, each with an email</span>
<span class="c1"># address and GitHub handle.</span>
<span class="c1">#</span>
<span class="c1"># These authors are not necessarily currently in charge of maintaining the code</span>
<span class="n">__authors__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;Jane Roe &lt;jane.roe@myuniversity.org&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;@janeroe&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;John Doe &lt;john.doe@otheruniversity.edu&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;@johndoe&quot;</span><span class="p">),</span>
<span class="p">]</span>

<span class="c1"># Current maintainers of the architecture code, using the same</span>
<span class="c1"># style as ``__authors__``</span>
<span class="n">__maintainers__</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;Joe Bloggs &lt;joe.bloggs@sotacompany.com&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;@joebloggs&quot;</span><span class="p">)]</span>
</pre></div>
</div>
</section>
<section id="documentation-documentation-py">
<span id="newarchitecture-documentation"></span><h2>Documentation (<code class="docutils literal notranslate"><span class="pre">documentation.py</span></code>)<a class="headerlink" href="#documentation-documentation-py" title="Link to this heading">¶</a></h2>
<p>The documentation file is used to define:</p>
<ul class="simple">
<li><p>The hyperparameters for the model class.</p></li>
<li><p>The hyperparameters for the trainer class.</p></li>
<li><p>The text that will go to the online documentation for the architecture.</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This file is meant to be imported separately to generate the
documentation page for the architecture without needing the
extra dependencies that the architecture might require.</p>
<p>Therefore, all imports in this file should be absolute and this
file should not import the rest of the architecture code unless
the architecture has no extra dependencies.</p>
</div>
<section id="bare-minimum">
<h3>Bare minimum<a class="headerlink" href="#bare-minimum" title="Link to this heading">¶</a></h3>
<p>We understand that during development of a new architecture expecting full
documentation for all hyperparameters is unreasonable. Therefore, <code class="docutils literal notranslate"><span class="pre">metatrain</span></code>
will work with a very minimal <code class="docutils literal notranslate"><span class="pre">documentation.py</span></code> file containing only the
default hyperparameters for both the model and the trainer. One just
needs to define a <code class="docutils literal notranslate"><span class="pre">ModelHypers</span></code> and a <code class="docutils literal notranslate"><span class="pre">TrainerHypers</span></code>, for the hypers of the
model and the trainer respectively.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># This is the most minimal documentation.py file possible.</span>
<span class="c1"># Something like this should only be used during development.</span>

<span class="c1"># Default hyperparameters for the model</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ModelHypers</span><span class="p">:</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mi">150</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;strict&quot;</span>

<span class="c1"># Default hyperparameters for the trainer</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TrainerHypers</span><span class="p">:</span>
    <span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">1e-3</span>
    <span class="n">lr_scheduler</span> <span class="o">=</span> <span class="s2">&quot;CosineAnnealing&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The name of these classes (<code class="docutils literal notranslate"><span class="pre">ModelHypers</span></code> and <code class="docutils literal notranslate"><span class="pre">TrainerHypers</span></code>), as well
as the file they are in (<code class="docutils literal notranslate"><span class="pre">documentation.py</span></code>) are <strong>mandatory</strong>.
<code class="docutils literal notranslate"><span class="pre">metatrain</span></code> will look for these specific names when loading the
architecture.</p>
<p>This rigidity allows <code class="docutils literal notranslate"><span class="pre">metatrain</span></code> to easily generate documentation pages
and maintain a consistent experience across all architectures.</p>
</div>
</section>
<section id="for-an-experimental-architecture">
<h3>For an experimental architecture<a class="headerlink" href="#for-an-experimental-architecture" title="Link to this heading">¶</a></h3>
<p>For an architecture to be considered accepted as “experimental” into the
main <code class="docutils literal notranslate"><span class="pre">metatrain</span></code> distribution, <code class="docutils literal notranslate"><span class="pre">documentation.py</span></code> should at least contain:</p>
<ul class="simple">
<li><p>A minimal docstring at the top of the file with at least a short description
of the architecture. It should contain as a title the name of the architecture,
underlined with equal signs (<code class="docutils literal notranslate"><span class="pre">=</span></code>).</p></li>
<li><p>Some documentation for each hyperparameter.</p></li>
</ul>
<p>For example, this would be a valid <code class="docutils literal notranslate"><span class="pre">documentation.py</span></code> file for an
experimental architecture:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">My architecture</span>
<span class="sd">===============</span>

<span class="sd">This is an architecture that does amazing things.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ModelHypers</span><span class="p">:</span>

    <span class="n">size</span> <span class="o">=</span> <span class="mi">150</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Size of the model&#39;s hidden layers.&quot;&quot;&quot;</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;strict&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mode of operation for the model.&quot;&quot;&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TrainerHypers</span><span class="p">:</span>
    <span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initial learning rate for the optimizer.&quot;&quot;&quot;</span>
    <span class="n">lr_scheduler</span> <span class="o">=</span> <span class="s2">&quot;CosineAnnealing&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Type of learning rate scheduler to use.&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>You can check <a class="reference internal" href="#newarchitecture-documentation-page"><span class="std std-ref">this section</span></a> to
understand how the module docstring will be used to generate the documentation
page for the architecture.</p>
</section>
<section id="for-a-stable-architecture">
<h3>For a stable architecture<a class="headerlink" href="#for-a-stable-architecture" title="Link to this heading">¶</a></h3>
<p>Going from experimental to stable architecture requires one last step:
documentation of the hyperparameters types. This is done using <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code>
and Python’s type hinting system, and it allows <code class="docutils literal notranslate"><span class="pre">metatrain</span></code> to automatically
validate user inputs. By doing validation, <code class="docutils literal notranslate"><span class="pre">metatrain</span></code> can give users
meaningful error messages when the provided hyperparameters are invalid,
avoiding errors deep inside the architecture that would be harder to understand.</p>
<p>Here is the example of the previous <code class="docutils literal notranslate"><span class="pre">documentation.py</span></code> file, now ready for
the architecture to be considered stable:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">My architecture</span>
<span class="sd">===============</span>

<span class="sd">This is an architecture that does amazing things.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ModelHypers</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>

    <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Size of the model&#39;s hidden layers.&quot;&quot;&quot;</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;strict&quot;</span><span class="p">,</span> <span class="s2">&quot;lenient&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;strict&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mode of operation for the model.&quot;&quot;&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TrainerHypers</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initial learning rate for the optimizer.&quot;&quot;&quot;</span>
    <span class="n">lr_scheduler</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;CosineAnnealing&quot;</span><span class="p">,</span> <span class="s2">&quot;StepLR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;CosineAnnealing&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Type of learning rate scheduler to use.&quot;&quot;&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is important to use <code class="docutils literal notranslate"><span class="pre">typing_extensions.TypedDict</span></code> instead of
<code class="docutils literal notranslate"><span class="pre">typing.TypedDict</span></code> for compatibility with <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">&lt;=</span> <span class="pre">3.12</span></code> in pydantic’s
validation system.</p>
</div>
<p>With this, you will be almost ready to have your architecture accepted as stable.
The last step is to update the <code class="docutils literal notranslate"><span class="pre">Model</span></code> and <code class="docutils literal notranslate"><span class="pre">Trainer</span></code> classes so that they are
aware of the hyperparameter types. This will help static type checkers like mypy
catch bugs in your code, as well as improving the development experience in IDE’s
like VSCode or PyCharm. To do this, you just have to:</p>
<ul class="simple">
<li><p>Make your model and trainer classes inherit from <code class="docutils literal notranslate"><span class="pre">ModelInterface[ModelHypers]</span></code>
and <code class="docutils literal notranslate"><span class="pre">TrainerInterface[TrainerHypers]</span></code> respectively, instead of just
<code class="docutils literal notranslate"><span class="pre">ModelInterface</span></code> and <code class="docutils literal notranslate"><span class="pre">TrainerInterface</span></code>.</p></li>
<li><p>Add the hypers type annotation to the <code class="docutils literal notranslate"><span class="pre">hypers</span></code> argument of the <code class="docutils literal notranslate"><span class="pre">__init__</span></code>
method of both classes, as well as any other method that takes hyperparameters
as input (like <code class="docutils literal notranslate"><span class="pre">Trainer.load_checkpoint</span></code>).</p></li>
</ul>
<p>For example, for the model:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">metatomic.torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatasetInfo</span><span class="p">,</span> <span class="n">ModelMetadata</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">metatrain.utils.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelInterface</span>

<span class="c1"># New import to get the ModelHypers type</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.documentation</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelHypers</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyModel</span><span class="p">(</span><span class="n">ModelInterface</span><span class="p">[</span><span class="n">ModelHypers</span><span class="p">]):</span> <span class="c1"># Add the hypers type here</span>
    <span class="n">__checkpoint_version__</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">__supported_devices__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cuda&quot;</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">]</span>
    <span class="n">__supported_dtypes__</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span>
    <span class="n">__default_metadata__</span> <span class="o">=</span> <span class="n">ModelMetadata</span><span class="p">(</span>
        <span class="n">references</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;implementation&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;ref1&quot;</span><span class="p">],</span> <span class="s2">&quot;architecture&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;ref2&quot;</span><span class="p">]}</span>
    <span class="p">)</span>

    <span class="c1"># Type hint the hypers argument of __init__</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hypers</span><span class="p">:</span> <span class="n">ModelHypers</span><span class="p">,</span> <span class="n">dataset_info</span><span class="p">:</span> <span class="n">DatasetInfo</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">hypers</span><span class="p">,</span> <span class="n">dataset_info</span><span class="p">)</span>
        <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="documentation-page">
<span id="newarchitecture-documentation-page"></span><h3>Documentation page<a class="headerlink" href="#documentation-page" title="Link to this heading">¶</a></h3>
<p>By following the guidelines for documenting hyperparameters, <code class="docutils literal notranslate"><span class="pre">metatrain</span></code>
<strong>will automatically generate a documentation page for the new architecture</strong>.
This documentation page will contain information about how to install your
architecture, the default hyperparameters, and the descriptions of all
the hyperparameters for both the model and the trainer.</p>
<p>The documentation page will be generated from the docstring at the top of the
<code class="docutils literal notranslate"><span class="pre">documentation.py</span></code> file, as well as the <code class="docutils literal notranslate"><span class="pre">ModelHypers</span></code> and <code class="docutils literal notranslate"><span class="pre">TrainerHypers</span></code>
classes defined there. Here is the description of how the docstring will
be generated:</p>
<dl class="py class">
<dt class="sig sig-object py">
<em class="property"><span class="k"><span class="pre">class</span></span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">src.architectures.generate.</span></span><span class="sig-name descname"><span class="pre">ArchitectureDocVariables</span></span><a class="reference internal" href="../_modules/src/architectures/generate.html#ArchitectureDocVariables"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Variables to use inside the architecture documentation.</p>
<p>The docstring of the architecture will be processed as a
<code class="docutils literal notranslate"><span class="pre">jinja</span></code> template. You can find documentation about them
<a class="reference external" href="https://jinja.palletsprojects.com/en/stable/templates">here</a> , but
the simplest functionality consists of using variables enclosed in
double curly braces <code class="docutils literal notranslate"><span class="pre">{{variable_name}}</span></code>, which will be replaced by
their corresponding value.</p>
<p>For example, a file with the following content:</p>
<div class="highlight-rst notranslate"><div class="highlight"><pre><span></span>This is the documentation for {{architecture}}.
</pre></div>
</div>
<p>generates a documentation file that for the architecture <code class="docutils literal notranslate"><span class="pre">pet</span></code> would be:</p>
<div class="highlight-rst notranslate"><div class="highlight"><pre><span></span>This is the documentation for pet.
</pre></div>
</div>
<p>There are some special variables that start with <code class="docutils literal notranslate"><span class="pre">SECTION_</span></code>. These contain
the content of different sections of the documentation, and they will be
appended to the docstring if they are not already present. For example, given
the docstring:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">My architecture</span>
<span class="sd">===============</span>

<span class="sd">This is my architecture.</span>

<span class="sd">{{SECTION_DEFAULT_HYPERS}}</span>

<span class="sd">Some important section</span>
<span class="sd">======================</span>

<span class="sd">Explain something important here.</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>The final documentation will append to the docstring all the sections except
<code class="docutils literal notranslate"><span class="pre">SECTION_DEFAULT_HYPERS</span></code>, since it is already present.</p>
<p>Following you can find a description of all the available variables. The
sections are appended in the order documented here.</p>
<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">SECTION_INSTALLATION</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a></em></dt>
<dd><p>Section containing installation instructions for this architecture.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">SECTION_DEFAULT_HYPERS</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a></em></dt>
<dd><p>Section containing a yaml file with the default hyperparameters for
this architecture.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">SECTION_MODEL_HYPERS</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a></em></dt>
<dd><p>Section containing the description of the model hyperparameters for
this architecture.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">SECTION_TRAINER_HYPERS</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a></em></dt>
<dd><p>Section containing the description of the trainer hyperparameters for
this architecture.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">SECTION_REFERENCES</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a></em></dt>
<dd><p>Section containing references for this architecture. It will render the
references that have been used as <code class="docutils literal notranslate"><span class="pre">:footcite:p:</span></code> during the architecture
documentation.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">architecture</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a></em></dt>
<dd><p>The name of the architecture.</p>
<p>This excludes any ‘experimental.’ or ‘deprecated.’ prefix.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">architecture_path</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a></em></dt>
<dd><p>The full python import path to the architecture.</p>
<p>E.g.: <code class="docutils literal notranslate"><span class="pre">&quot;metatrain.experimental.my_architecture&quot;</span></code></p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">default_hypers_path</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a></em></dt>
<dd><p>Path to the yaml file with the default hyperparameters for this
architecture.</p>
<p>This is a path relative to the <code class="docutils literal notranslate"><span class="pre">docs/src/architectures/generated</span></code>
directory.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">model_hypers_path</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a></em></dt>
<dd><p>The full python import path to the model’s hypers class of this
architecture.</p>
<p>E.g.: <code class="docutils literal notranslate"><span class="pre">&quot;metatrain.pet.documentation.ModelHypers&quot;</span></code></p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">trainer_hypers_path</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a></em></dt>
<dd><p>The full python import path to the trainer’s hypers class of this
architecture.</p>
<p>E.g.: <code class="docutils literal notranslate"><span class="pre">&quot;metatrain.pet.documentation.TrainerHypers&quot;</span></code></p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">model_hypers</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#list" title="(in Python v3.14)"><span class="pre">list</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a><span class="p"><span class="pre">]</span></span></em></dt>
<dd><p>List of model hyperparameter names for this architecture.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">trainer_hypers</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#list" title="(in Python v3.14)"><span class="pre">list</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.14)"><span class="pre">str</span></a><span class="p"><span class="pre">]</span></span></em></dt>
<dd><p>List of trainer hyperparameter names for this architecture.</p>
</dd></dl>

</dd></dl>

</section>
</section>
<section id="checkpoint-versioning">
<span id="ckpt-version"></span><h2>Checkpoint versioning<a class="headerlink" href="#checkpoint-versioning" title="Link to this heading">¶</a></h2>
<p>Checkpoints are used to save the weights of a models and the state of the
trainer to disk, enabling to restart interupted training runs, to fine-tune
existing models on new dataset, and to export standalone models based on
TorchScript.</p>
<p>A checkpoint created for one version might need to be read again
by a later version of the architecture, where the internal structure might have
changed. To enable this, all <code class="docutils literal notranslate"><span class="pre">Model</span></code> classes are required to have a
<code class="docutils literal notranslate"><span class="pre">__checkpoint_version__</span></code> class attribute containing the version of the
checkoint, as a strictly inreasing integer. Additionally, architectures should
provide an <code class="docutils literal notranslate"><span class="pre">upgrade_checkpoint(checkpoint:</span> <span class="pre">Dict)</span> <span class="pre">-&gt;</span> <span class="pre">Dict</span></code> function, that will
be called when a user is trying to load some outdated checkpoint. This function
is responsible for updating the checkpoint data and returning a checkpoint
compatible with the current version.</p>
<p>Similarly, the <code class="docutils literal notranslate"><span class="pre">Trainer</span></code> state is also saved in checkpoint and used to restart
training. All trainer must thus have a <code class="docutils literal notranslate"><span class="pre">__checkpoint_version__</span></code> class
attribute as well as a <code class="docutils literal notranslate"><span class="pre">upgrade_checkpoint(checkpoint:</span> <span class="pre">Dict)</span> <span class="pre">-&gt;</span> <span class="pre">Dict</span></code> function
to updgrade from previous checkpoints.</p>
</section>
<section id="testing-tests">
<h2>Testing (<code class="docutils literal notranslate"><span class="pre">tests/</span></code>)<a class="headerlink" href="#testing-tests" title="Link to this heading">¶</a></h2>
<p>Metatrain aims to provide users with a consistent experience across
architectures. To ensure this, we must test that all architectures
behave in the “<code class="docutils literal notranslate"><span class="pre">metatrain</span></code> way”.</p>
<p>The good news is: <strong>you don’t have to write any tests!</strong> Since we know
that writing tests is not an enjoyable experience, <strong>we provide the
tests, you just have to make sure your architecture passes them.</strong> This
approach has several advantages:</p>
<ul class="simple">
<li><p>It saves you time and effort, since you don’t have to write tests.</p></li>
<li><p>It makes you confident that the architecture is well integrated into
<code class="docutils literal notranslate"><span class="pre">metatrain</span></code>.</p></li>
<li><p>New architectures have many lines of new code and they can be hard to
review, so the shared test suite helps us understanding if the
architecture is compliant and ready to be merged.</p></li>
<li><p>Users benefit from it, since they are guaranteed a consistent experience
across architectures.</p></li>
</ul>
<p>To make the tests run for your architecture, you should follow these steps:</p>
<blockquote>
<div><p><strong>Step 1:</strong> Create a <code class="docutils literal notranslate"><span class="pre">tests/</span></code> subdirectory inside your architecture directory.</p>
<p><strong>Step 2:</strong> Inside the <code class="docutils literal notranslate"><span class="pre">tests/</span></code> directory, create a new file called <code class="docutils literal notranslate"><span class="pre">test_basic.py</span></code>.</p>
<p><strong>Step 3:</strong> The <code class="docutils literal notranslate"><span class="pre">test_basic.py</span></code> file should contain the relevant classes from
<a class="reference internal" href="utils/testing.html#testing-utilities"><span class="std std-ref">metatrain.utils.testing</span></a>. Each <code class="docutils literal notranslate"><span class="pre">&lt;*&gt;Tests</span></code> class tests a
different kind of functionality, and can be tuned to enable/disable certain tests for
your architecture. You can get inspired by existing architectures’
<code class="docutils literal notranslate"><span class="pre">test_basic.py</span></code> files, but here is an example for an architecture called
<code class="docutils literal notranslate"><span class="pre">experimental.myarchitecture</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">metatrain.utils.testing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">AutogradTests</span><span class="p">,</span>
    <span class="n">CheckpointTests</span><span class="p">,</span>
    <span class="n">ExportedTests</span><span class="p">,</span>
    <span class="n">InputTests</span><span class="p">,</span>
    <span class="n">OutputTests</span><span class="p">,</span>
    <span class="n">TorchscriptTests</span><span class="p">,</span>
    <span class="n">TrainingTests</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestInput</span><span class="p">(</span><span class="n">InputTests</span><span class="p">):</span>
    <span class="n">architecture</span> <span class="o">=</span> <span class="s2">&quot;experimental.myarchitecture&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestAutograd</span><span class="p">(</span><span class="n">AutogradTests</span><span class="p">):</span>
    <span class="n">architecture</span> <span class="o">=</span> <span class="s2">&quot;experimental.myarchitecture&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestTorchscript</span><span class="p">(</span><span class="n">TorchscriptTests</span><span class="p">):</span>
    <span class="n">architecture</span> <span class="o">=</span> <span class="s2">&quot;experimental.myarchitecture&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestExported</span><span class="p">(</span><span class="n">ExportedTests</span><span class="p">):</span>
    <span class="n">architecture</span> <span class="o">=</span> <span class="s2">&quot;experimental.myarchitecture&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestTraining</span><span class="p">(</span><span class="n">TrainingTests</span><span class="p">):</span>
    <span class="n">architecture</span> <span class="o">=</span> <span class="s2">&quot;experimental.myarchitecture&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestCheckpoints</span><span class="p">(</span><span class="n">CheckpointTests</span><span class="p">):</span>
    <span class="n">architecture</span> <span class="o">=</span> <span class="s2">&quot;experimental.myarchitecture&quot;</span>
</pre></div>
</div>
<p>Some test suite might not apply to your architecture, e.g. if your model
does not support autograd. In that case, simply explain this in your PR
and the maintainers will help you decide if it’s ok to just omit them.
You can of course add more tests that you find relevant for your architecture,
but passing <code class="docutils literal notranslate"><span class="pre">metatrain</span></code>’s shared test suite is a sufficient
condition for merging a new architecture.</p>
<p><strong>Step 4:</strong> Add your architecture tests to the <code class="docutils literal notranslate"><span class="pre">tox.ini</span></code> file. For this, you have to
add a section <code class="docutils literal notranslate"><span class="pre">[testenv:myarchitecture-tests]</span></code>. You can get inspired by
existing architectures, e.g. the section <code class="docutils literal notranslate"><span class="pre">[testenv:pet-tests]</span></code>. You will also need
to add your tests to the <code class="docutils literal notranslate"><span class="pre">envlist</span></code> variable at the top of the <code class="docutils literal notranslate"><span class="pre">tox.ini</span></code> file.</p>
<p><strong>Step 5:</strong> Run your tests. For this, you will need to install <code class="docutils literal notranslate"><span class="pre">tox</span></code>. You can do this
with <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">tox</span></code>. Then, from the root of the repository, run
<code class="docutils literal notranslate"><span class="pre">tox</span> <span class="pre">-e</span> <span class="pre">myarchitecture-tests</span></code>. See <a class="reference internal" href="getting-started.html#contributing-running-tests"><span class="std std-ref">the contributing page</span></a>
for more details on how to run tests.</p>
<p><strong>Step 6:</strong> Add your architecture tests to the continuous integration (CI) system. This
is done by adding <code class="docutils literal notranslate"><span class="pre">myarchitecture-tests</span></code> to the file
<code class="docutils literal notranslate"><span class="pre">.github/workflows/architecture-tests.yml</span></code>.</p>
</div></blockquote>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="dataset-information.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Dataset Information</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="architecture-life-cycle.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Life Cycle of an Architecture</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2026, metatrain developers
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link fa-brands fa-github fa-2x" href="https://github.com/metatensor/metatrain" aria-label="GitHub"></a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Adding a new architecture</a><ul>
<li><a class="reference internal" href="#what-is-a-metatrain-architecture">What is a <code class="docutils literal notranslate"><span class="pre">metatrain</span></code> architecture?</a></li>
<li><a class="reference internal" href="#general-code-structure">General code structure</a></li>
<li><a class="reference internal" href="#model-class-model-py">Model class (<code class="docutils literal notranslate"><span class="pre">model.py</span></code>)</a></li>
<li><a class="reference internal" href="#trainer-class-trainer-py">Trainer class (<code class="docutils literal notranslate"><span class="pre">trainer.py</span></code>)</a></li>
<li><a class="reference internal" href="#init-file-init-py">Init file (<code class="docutils literal notranslate"><span class="pre">__init__.py</span></code>)</a></li>
<li><a class="reference internal" href="#documentation-documentation-py">Documentation (<code class="docutils literal notranslate"><span class="pre">documentation.py</span></code>)</a><ul>
<li><a class="reference internal" href="#bare-minimum">Bare minimum</a></li>
<li><a class="reference internal" href="#for-an-experimental-architecture">For an experimental architecture</a></li>
<li><a class="reference internal" href="#for-a-stable-architecture">For a stable architecture</a></li>
<li><a class="reference internal" href="#documentation-page">Documentation page</a></li>
</ul>
</li>
<li><a class="reference internal" href="#checkpoint-versioning">Checkpoint versioning</a></li>
<li><a class="reference internal" href="#testing-tests">Testing (<code class="docutils literal notranslate"><span class="pre">tests/</span></code>)</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=3822dbdc"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=46bd48cc"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/toggleprompt.js?v=5801b3bb"></script>
    </body>
</html>